<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Village Generator</title>
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/main.css">
  <style>
    body::before {
      background-image: url('../styles/images/village.png');
    }
  </style>
</head>
<body>
  <div class="page-container">
    <h1>Village Generator</h1>
    <div class="container">
      <button class="blocky-btn" id="villageSeedBtn">Generate Seed</button>
      <div class="download-box" id="villageDownloadBox">
        <a href="../ranked-addon.mcaddon" download class="blocky-btn filter-btn">Download Village FSG Pack</a>
      </div>
      <div class="seed-box" id="villageSeedBox"></div>
      <div class="cooldown" id="villageCooldownMsg"></div>
      <div class="navigation-buttons">
        <button class="blocky-btn back-btn" onclick="window.location.href='../index.html'">‚Üê Back</button>
        <button class="blocky-btn help-btn" onclick="window.location.href='help.html'">Help</button>
      </div>
    </div>
  </div>

  <script>
    let villageSeeds = [];
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxMxZ9zStBmy6ERJk1ne6_-zH8eOEce5ISf_wcWYmq2tHYhrwKmNSaYZ_LzDYEHQn3mIQ/exec';
    let cooldownActive = false;
    let cooldownTime = 10;

    async function logToGoogleSheet(seed, filterType) {
      try {
        const timestamp = new Date().toISOString();
        const data = {
          seed: seed,
          filterType: filterType,
          timestamp: timestamp,
          userAgent: navigator.userAgent,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };

        await fetch(GOOGLE_SHEET_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      } catch (error) {
        console.error('Error logging to Google Sheets:', error);
      }
    }

    async function loadSeeds() {
      try {
        const response = await fetch("../village.json");
        villageSeeds = await response.json();
        document.getElementById("villageSeedBtn").disabled = false;
      } catch (err) {
        console.error("Error loading seeds:", err);
      }
    }

    function getRandomSeed(seedArray) {
      const idx = Math.floor(Math.random() * seedArray.length);
      return seedArray[idx];
    }

    function startCooldown() {
      cooldownActive = true;
      let timeLeft = cooldownTime;
      const btn = document.getElementById('villageSeedBtn');
      const cooldownMsg = document.getElementById('villageCooldownMsg');

      btn.disabled = true;
      cooldownMsg.textContent = `Cooldown: ${timeLeft}s`;

      const interval = setInterval(() => {
        timeLeft--;
        cooldownMsg.textContent = `Cooldown: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(interval);
          btn.disabled = false;
          cooldownMsg.textContent = '';
          cooldownActive = false;
        }
      }, 1000);
    }

    document.getElementById('villageSeedBtn').addEventListener('click', () => {
      if (!cooldownActive && villageSeeds.length > 0) {
        const seedBox = document.getElementById('villageSeedBox');
        const seed = getRandomSeed(villageSeeds);
        seedBox.textContent = seed;
        seedBox.style.display = 'flex';
        logToGoogleSheet(seed, 'Village');
        startCooldown();
      }
    });

    document.getElementById('villageSeedBox').addEventListener('dblclick', () => {
      const box = document.getElementById('villageSeedBox');
      const seed = box.textContent.trim();
      if (seed !== "" && seed !== "Seed copied!") {
        navigator.clipboard.writeText(seed).then(() => {
          box.textContent = "Seed copied!";
          setTimeout(() => {
            box.textContent = seed;
          }, 1500);
        }).catch(err => {
          console.error("Error in copy:", err);
        });
      }
    });

    document.getElementById("villageSeedBtn").disabled = true;
    loadSeeds();
  </script>
</body>
</html>
